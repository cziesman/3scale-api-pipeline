#!groovy
library identifier: '3scale-toolbox-jenkins@master',
        retriever: modernSCM(
                [$class: 'GitSCMSource',
                 remote: 'https://github.com/rh-integration/3scale-toolbox-jenkins.git',
                 traits: [[$class: 'jenkins.plugins.git.traits.BranchDiscoveryTrait']]])

def service = null

def baseSystemName = "widget"
def accessToken = "23aff03d2f1f92a1e167c7012b752fbe7163242b9e6dee712dbf7b784d89beba"
def targetSystemName = "widget-api"
def targetInstance = "https://${accessToken}@3scale-admin.6dsvl.apps.shared-na46.openshift.opentlc.com"
def privateBaseURL = "http://three-scale-api-3scale-api.apps.shared-na46.openshift.opentlc.com"
def privateBasePath = "/api"
def developerAccountId = "john"
def publicStagingBaseURL = "3scale-apicast-staging.6dsvl.apps.shared-na46.openshift.opentlc.com"
def publicProductionBaseURL = "3scale-apicast-production.6dsvl.apps.shared-na46.openshift.opentlc.com"
def disableTlsValidation = true
def secretName = "3scale-toolbox"
def namespace = "jenkins"
def imageName = "quay.io/redhat/3scale-toolbox"


String jobId(int length) {

    source = "abcdefghijklmnopqrstuvwxyz0123456789";
    random = new Random();

    builder = new StringBuilder(length);
    for (int i = 0; i < length; i++) {
        builder.append(source[random.nextInt(source.length() - 1)]);
    }

    return builder.toString().toLowerCase();
}

String pod(String prefix, String pods) {

    for (String item : pods.split("\n")) {
        if (item.startsWith(prefix)) {
            return item;
        }
    }

    return null;
}

void waitForSuccess(String pod) {

    phase = ""
    while (!"Succeeded".equals(phase)) {
        sleep 1
        phase = openshift.raw("get pod ${pod} -o custom-columns=POD:.status.phase --no-headers").out.trim()
        echo "phase = " + phase
    }
}

String jobOutput(String pod) {

    return openshift.raw("logs ${pod}").out
}

pipeline {

    agent {
        label "master"
    }

    environment {
        APP_BASE_NAME = "widget"
        APP_API_NAME = "${APP_BASE_NAME}--api"
        CICD_NAMESPACE = "jenkins"

        OCP_TOKEN = readFile('/var/run/secrets/kubernetes.io/serviceaccount/token').trim()
    }
    stages {

        stage('First stage') {
            steps {
                script {

                    echo 'Inside first stage'
                }
            }
        }

        stage('Get list of services') {
            steps {
                script {

                    openshift.withCluster() {
                        openshift.withProject("${env.CICD_NAMESPACE}") {
                            jobName = commandLine = "3scale service list --output=json --insecure ${targetInstance}"
                            jobId = "3scale-toolbox-" + jobId(5)
                            echo "jobId = " + jobId

                            openshift.raw("create job ${jobId} --image=quay.io/redhat/3scale-toolbox -- ${commandLine}")
                            sleep 1
                            pods = openshift.raw("get pods -o custom-columns=POD:.metadata.name --no-headers").out
                            echo "pods = " + pods

                            pod = pod(jobId, pods)
                            echo "pod = " + pod

                            timeout(time: 20, unit: 'SECONDS') {
                                node {
                                    waitForSuccess(pod)

                                    jobOutput = jobOutput(pod)
                                    echo "jobOutput = " + groovy.json.JsonOutput.prettyPrint(jobOutput)
                                }
                            }

                            openshift.raw("delete job ${jobId}")
                        }
                    }
                }
            }
        }
    }
}
